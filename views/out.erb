
<style>

[draggable] {
    -moz-user-select: none;
    -khtml-user-select: none;
    -webkit-user-select: none;
    user-select: none;
}
 
#tags-list .tag {
    cursor: alias;
}

#tags-list-panel .tag {
    cursor: grab;
}

.tag {
	margin: 2px;
}

.tag-title {
	font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
	font-size: 14px;
}

.dropTarget {
	background-color: #fafafa;
	border: 1px dashed #269ABC;
}

.alert{
	display:none;
}

</style>

<div class="col-md-5 col-md-offset-1">
	<div class="panel panel-default">
		<div class="panel-heading">
	    	<h3 class="panel-title">#<%= @code %></h3>
	  	</div>
		<div class="panel-body">
			<% if USE_IMAGE == "Y" %>
				<div class="input-group">
				  <span class="input-group-addon input-group-lg" id="basic-addon3">
				  <% unless @item[0]['image_link'].empty? %>
				  	<img src="<%= @item[0]['image_link'] %>" class="img img-responsive img-rounded" alt=""/>
				  <% else %>
				  <span class="glyphicon glyphicon-picture"></span>
				  <% end %>
				  </span>
				</div>
			<% end %>
				<div class="input-group">
				  <span class="input-group-addon input-group-lg" id="basic-addon0"><span class="glyphicon glyphicon-bookmark"></span></span>
				  <input type="text" class="form-control" value="<%= @item[0]['name'] %>">
				</div>

				<div class="input-group">
				  <span class="input-group-addon input-group-lg" id="basic-addon1"><span class="glyphicon glyphicon-list-alt"></span></span>
				  <input type="text" class="form-control" value="<%= @item[0]['description'] %>">
				</div>

			<% if USE_CHECKINOUT_DATE == "Y" %>
				<div class="input-group">
				  <span class="input-group-addon input-group-lg" title="<%= _t 'Check-out date' %>"><span class="glyphicon glyphicon-calendar"></span>&nbsp;<span class="glyphicon glyphicon-export"></span></span>
				  <input type="date" id="outDate" class="form-control" value="<%= @item[0]['checkout_date'] || Time.now.strftime('%Y-%m-%d') %>">
				</div>

				<div class="input-group" id="inDateGrp">
				  <span class="input-group-addon input-group-lg" title="<%= _t 'Planned check in date' %>"><span class="glyphicon glyphicon-calendar"></span>&nbsp;<span class="glyphicon glyphicon-import"></span></span>
				  <input type="date" id="inDate" class="form-control" value="<%= @item[0]['checkin_date'] %>">
				</div>
			    <div class="alert alert-danger" role="alert" id="inDateTT"><%= _t 'Check in date must be further than check out' %></div>
			<% end %>

				<div class="input-group input-group-lg">
				  <span class="input-group-addon input-group-lg" id="basic-addon2"><span class="glyphicon glyphicon-tags"></span></span>
				  <div class="form-control" id="tags-list" name="tags-list">
					  <% @assigned_tags.each { | tag | %>
						<div class="tag btn <%= tag['color'] %>" id="tag<%= tag['id'] %>">
						  <span class="tag-title"><%= tag['tag'] %></span> 
						  <!--span class="badge"><%= tag['count_items'] %></span-->
						</div>
					  <% } %>
				  </div>
				</div>
		</div>
	</div>
</div>

<div class="col-md-5">
	<div class="panel panel-default">
		<div class="panel-heading">
	    	<h3 class="panel-title"><%= _t 'List of tags' %></h3>
	  	</div>
		<div class="panel-body" id="tags-list-panel">
		  <% @available_tags.each { | tag | %>
			<div class="tag btn <%= tag['color'] %>" id="tag<%= tag['id'] %>">
			  <span class="tag-title"><%= tag['tag'] %></span> 
			</div>
		  <% } %>
		 </div>
	</div>
</div>

<div class="col-md-10 col-md-offset-1">
	<form id="checkoutForm" action="<%= APP_PATH %>/item/checkout" method="post">
		<input type="hidden" name="code"  id="itemCode" value="<%= @code %>">
	</form>
	<button type="button" class="btn btn-default" id="cancelBtn" title="<%= _t 'Cancel checkout' %>"><%= _t 'Cancel' %></button>
	<button type="submit" class="btn btn-success" id="checkoutBtn"  title="<%= _t 'Checkout' %>"><%= _t 'Checkout' %>&nbsp;<span class="glyphicon glyphicon-export"></span></button>
</div>

<script>
$(document).ready( function() {
	var inDtGrp = $("#inDateGrp");
	var inDtErrMsg = $("#inDateTT");
	var code = $( "#itemCode" ).val();
	var cancekBtn = $( "#cancelBtn" );
	var chkBtn = $( "#checkoutBtn" );
	var frm = $("#checkoutForm");
	var cnt = $('#tags-list-panel, #tags-list');
	var countTags = $( "#tags-list" ).children(); // TODO : Compter le nombre d'éléments existants
	var check_dates = "<%= USE_CHECKINOUT_DATE %>";
	// Initial state of the page
	chkBtn.prop("disabled", true);
	$(".alert").hide();

	cnt.each(function( index ) {
	  var action = "add";
	  // for every click on or in this element
	  cnt.eq(index).on('click', '> *', function() {
	    // append will remove the element
	    // Number( !0 ) => 1, Number( !1 ) => 0
	    if ( Number(!index) == 0) {
	    	// Adding tags
	    	countTags++;
	    } else {
	    	// Removing Tags
	    	countTags--;
	    	action = "remove";
	    }  
	    // Sending ajax request
		$.ajax({
		  url: "<%= APP_PATH %>/tags/" + action + "/?code=<%= @code %>&id=" + this.id.replace('tag', '')
		})
		  .done(function( res ) {
		    console.log( res );
		  });
	    // updating the right layer
	    cnt.eq( Number(!index) ).append( this );
	    // Set right button state
	    chkBtn.prop("disabled", (countTags <= 0) );
	  });
	});

	// Controling check in & out date interval
	// Check in date value must be later than chek out date
	function checkDates() {
		var din = parseInt($('#inDate').val().replace(/-/g, '')),
			dout = parseInt($('#outDate').val().replace(/-/g, ''));
		if (isNaN(din)) {
			din = 0;
		}
		 return (din >= dout);
	}

	// Checkout button Listener
	chkBtn.click(function() {
		$(".alert").hide();
		var chkdt = (check_dates == "Y") ? checkDates() : true;
		if (chkdt) {
			frm.submit();
		} else {
			inDtGrp.addClass("has-error");
			inDtErrMsg.show();
		}
	});

	// Annulation Button
	cancekBtn.click(function(){
		location.href="<%= APP_PATH %>/item/checkin?code="+code;
	});

});
</script>